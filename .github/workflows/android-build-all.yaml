name: ğŸ“± æ„å»º Android-build-all

on:
  workflow_dispatch:
  push:  # æ¯æ¬¡ push åˆ°ä»“åº“æ—¶è§¦å‘
    tags:
      - 'v*'  # æŒ‡å®šè§¦å‘åˆ†æ”¯

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™å…¥æƒé™
      packages: write
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ğŸš€ è®¾ç½®å¼€å‘ç¯å¢ƒ
        uses: ./.github/actions/setup-flutter-rust
        with:
          platform: android
          rust-targets: 'armv7-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android'

      - name: ğŸ” é…ç½®åº”ç”¨ç­¾å
        uses: ./.github/actions/android-signing
        with:
          keystore-base64: ${{ secrets.KEYSTORE_BASE64 }}
          key-alias: ${{ secrets.KEY_ALIAS }}
          store-password: ${{ secrets.STORE_PASSWORD }}
          key-password: ${{ secrets.KEY_PASSWORD }}

      - name: ğŸ› ï¸ æ„å»º universal APK
        run: |
          # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
          flutter clean
          cd rust && cargo clean && cd ..
          
          # æ„å»ºå…¨æ¶æ„ APK
          flutter build apk --release --android-skip-build-dependency-validation

      - name: ğŸ“¤ ä¸Šä¼ å…¨æ¶æ„ APK åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: astral-universal-apk
          path: build/app/outputs/flutter-apk/app-release.apk
