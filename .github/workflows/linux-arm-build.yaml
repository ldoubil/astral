name: ğŸ§ æ„å»º Linux ARM64 åº”ç”¨

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-arm:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ğŸ³ è®¾ç½® QEMU æ¨¡æ‹Ÿå™¨
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: ğŸ³ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ› ï¸ åœ¨ ARM64 å®¹å™¨ä¸­æ„å»ºåº”ç”¨
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:24.04 bash -c '
              set -e
              echo "=== å®‰è£…åŸºç¡€ä¾èµ– ==="
              apt-get update
              apt-get install -y curl git unzip xz-utils zip libglu1-mesa
              apt-get install -y build-essential ninja-build libgtk-3-dev
              apt-get install -y clang cmake pkg-config libcurl4-openssl-dev
              apt-get install -y protobuf-compiler
              apt-get install -y libayatana-appindicator3-dev
              apt-get install -y patchelf
              apt-get install -y ruby-dev
              gem install --no-document fpm
              
              echo "=== å®‰è£… Rust ==="
              curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.89.0 --profile minimal
              . "$HOME/.cargo/env"
              rustc --version
              
              echo "=== å®‰è£… Flutter ==="
              git clone https://github.com/flutter/flutter.git -b stable /opt/flutter --depth 1
              export PATH="/opt/flutter/bin:$PATH"
              flutter --version
              flutter config --enable-linux-desktop
              flutter create --platforms=linux .
              
              echo "=== æ„å»ºåº”ç”¨ ==="
              flutter pub get
              flutter build linux --release
              
              echo "=== æ‰“åŒ…åº”ç”¨ ==="
              mkdir -p release
              cd build/linux/arm64/release/bundle
              patchelf astral --add-needed libisar.so --add-needed librust_lib_astral.so || true
              tar -czf /workspace/release/astral-linux-arm64.tar.gz *
              
              echo "=== æ‰“åŒ… deb åŒ… ==="
              fpm -s dir -t deb -n astral -v 1.0.0 -a arm64 --prefix /opt/astral -C /workspace/build/linux/arm64/release/bundle .
              mv *.deb /workspace/release/astral-linux-arm64.deb
              
              echo "=== æ‰“åŒ… rpm åŒ… ==="
              fpm -s dir -t rpm -n astral -v 1.0.0 -a arm64 --prefix /opt/astral -C /workspace/build/linux/arm64/release/bundle .
              mv *.rpm /workspace/release/astral-linux-arm64.rpm
              
              echo "=== æ„å»ºå®Œæˆ ==="
              ls -lh /workspace/release/
            '

      - name: ğŸ“¤ ä¸Šä¼ æ‰€æœ‰ Linux ARM64 æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: astral-linux-arm64-all
          path: |
            release/astral-linux-arm64.tar.gz
            release/astral-linux-arm64.deb
            release/astral-linux-arm64.rpm
          retention-days: 7
